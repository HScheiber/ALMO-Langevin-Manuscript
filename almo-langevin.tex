%\documentclass[journal=jacsat]{achemso}

\documentclass[aps,prl,reprint,amsmath,amssymb]{revtex4-1}

% define variable that compiles the main text (as opposed to SI text)
%\newcommand*{\MAINTEXT}{}

%\documentclass[10pt,aps,prl,twocolumn,amsmath,amssymb,superscriptaddress,longbibliography]{revtex4-1}
%\documentclass[preprint,showpacs,preprintnumbers,amsmath,amssymb]{revtex4-1}
%\documentclass[twocolumn,showpacs,preprintnumbers,amsmath,amssymb]{revtex4}
% Some other (several out of many) possibilities
%\documentclass[preprint,aps]{revtex4}
%\documentclass[preprint,aps,draft]{revtex4}
%\documentclass[prb,amsmath,amssymb]{revtex4}% Physical Review B

\usepackage{graphicx}% Include figure files
\usepackage{dcolumn}% Align table columns on decimal point
\usepackage{bm}% bold math
\usepackage{amsmath}% bold math
\usepackage{siunitx}% si units
\usepackage{color}
\usepackage{graphicx}
%\usepackage[normalem]{ulem}
%\nofiles

%\bibliographystyle{achemso}
%\bibliographystyle{naturemag}
%\bibliographystyle{abbrv}

\begin{document}

\ifdefined\MAINTEXT
\else
	\clearpage
	%\widetext
	\setcounter{figure}{0}
	\setcounter{page}{1}
	\renewcommand{\thefigure}{S\arabic{figure}}
\fi

\title{
\ifdefined\MAINTEXT
\else
Supplemental Material: \\
\fi
Low-cost linear-scaling \emph{ab initio} molecular dynamics for weakly-interacting systems
%%for weakly-coupled atoms
%% for non-covalently bonded atoms
}

\author{Hayden Scheiber}
\email{scheiber@chem.ubc.ca}
\author{Yifei Shi}
\author{Rustam Z. Khaliullin}
\email{rustam.khaliullin@mcgill.ca}
\affiliation{Department of Chemistry, McGill University, 801 Sherbrooke St. West, Montreal, QC H3A 0B8, Canada}

\date{\today}

\ifdefined\MAINTEXT

\begin{abstract} 
A robust method for constructing compact localized orbitals in density functional theory enables us to create low-cost linear-scaling \emph{ab initio} molecular dynamics for weakly-interacting systems. High efficiency of simulations is achieved by calculating the forces approximately without lengthy optimization of localized orbitals and by adjusting the Langevin equation of motion to stabilize the dynamics with the imperfect forces. An application to liquid water demonstrates that extremely low computational overhead of this procedure makes it suitable for routine medium-size simulations whereas its linear scaling cost allows to extend accurate first-principle molecular dynamics to previously inaccessible time and length scales. 
\end{abstract}

\fi

\maketitle

\ifdefined\MAINTEXT

%\section{Introduction}

Since the unification of molecular dynamics and density functional theory (DFT)~\cite{a:thecpmd},
\emph{ab initio} molecular dynamics (AIMD) has become an important tool for the study of weakly bonded ensembles of molecules such as gas-phase molecular clusters, liquids, solutions, and molecular solids. %[of gas-phase molecules and condensed-phase systems.] 
Unfortunately, the computational cost of the conventional Kohn-Sham (KS) DFT grows cubically with the number of atoms, which severely limits the \emph{length scales} accessible by AIMD. %and hinders it application to large heterogeneous systems (interfaces, nuclei, defects). 
To address this issue, substantial efforts have been directed to the development of linear scaling (LS) DFT methods.

% RZK: search and include recent references
In all LS DFT methods, the \emph{delocalized} eigenstates of the effective KS Hamiltonian must be replaced with an alternative set of \emph{local} electronic descriptors
~\footnote{The delocalization of KS orbitals over all atoms is the main reason for the steep growth of the cost of KS DFT: since both the number of orbitals and the number of localization regions (e.g. atomic basis functions) increase linearly with the number of atoms, the total number of the electronic degrees of freedom grows quadratically.}. 
Most LS methods~\cite{a:ls-rev-1999,a:ls-rev-2012} explore the natural locality of the one-electron density matrix (DM). 
However, in typical DFT calculations that require diffuse basis functions, the DM approach is advantageous only for impractically large systems~\cite{a:ls-rev-1999,a:ls-dm-sign,a:almo-ls}.
Therefore, the application of DM-based LS methods have been restricted to minimal-basis tight-binding problems. 
The optimal basis variants of the DM methods~\cite{a:ls-stechel-1994,a:ls-gillan-1995,a:ls-gillan-1996,a:ls-onetep-2003} designed to rectify this issue contract large basis sets into a small number of new localized basis functions and then optimize the DM in the contracted basis. 
Although such methods have been successfully used for the evaluation of accurate DFT energies of large static systems~\cite{a:ls-onetep-2009,a:ls-conquest-2010,a:ls-onetep-2010-app1,a:ls-rev-2012} their use in AIMD is hampered by the costly optimization of both the contracted orbitals and the density matrix. 

% DM-based LS methods: a:linscale3,a:lee-yang-1996,a:ls-scuseria-1997,a:ls-manolopoulos-1998,a:ls-helgaker-2001,a:ls-niklasson-2003,a:curvy2,a:ls-dm-sign

To obviate the DM optimization, another set of electronic descriptors can be constructed by enforcing strict locality on one-electron orbitals and, necessarily, by relaxing the orthogonality constraints imposed on them. 
From the computational point of view, LS methods based on the direct optimization of such compact localized nonorthogonal orbitals~\cite{a:ls-galli-parrinello-1992,a:ls-mauri-galli-car-1993,a:ls-ordejon-1993,a:ls-mauri-galli-1994,a:ls-ordejon-1995,a:ls-kim-mauri-galli-1995,a:ls-fattebert-2004,a:ls-fattebert-2006,a:burger-yang-2008} are promising since they deal with fewer variational degrees of freedom than the DM methods. 
Unfortunately, the development of orbital-based LS methods has been all but abandoned because of the inherently difficult optimization of localized orbitals~\cite{a:ls-mauri-galli-car-1993,a:ls-ordejon-1995,a:ls-fattebert-2004,a:ls-rev-1999,a:weitao-yang-2013}. 

%RZK important addition for a more detialed publication: review of a large family of fragmentation methods into the review following these guidelines.
%It is important to note all LS DFT methods reviewed above attempt to obtain the electronic description that do not construct  based on fragmentation methods that do that there  LS DFT methods the presented logical partitioning with the subsequent construction of localized MOs is a rather general approach used in a large number of electronic structure theories, which are collectively known as fragmentation methods~\cite{a:fragmentation-rev}. These methods vary greatly in how the partitioning and recombination are performed and, therefore, differ in accuracy and computational cost. We would like to emphasize that in our approach a proper quantum mechanical description of the entire system is constructed in the form of the total idempotent density matrix. This approach provides the most rigorous description of the electronic structure.

Thus, the high computational overhead of existing asymptotically linear-scaling DFT methods restrict their use in AIMD simulations to very short \emph{time scales}, systems of low dimensions, or problems that can be adequately described with minimal basis sets. 
On the length and time scales accessible in typical AIMD simulations, LS DFT cannot compete with the straightforward low-cost cubically-scaling KS DFT.

In this work, we developed a new orbital-based AIMD method that is not only linear scaling but also has a low computational overhead. 
Currently, the method is restricted to systems of small molecules that do not form strong covalent bonds with each other. 
The new AIMD method utilizes a recently developed LS DFT~\cite{a:almo-ls} based on absolutely localized molecular orbitals (\mbox{ALMOs}). 
Unlike delocalized KS orbitals, each \mbox{ALMO} has its own localization center and a predefined localization radius $R_{c}$ that typically includes nearby atoms or molecules~\cite{a:stoll,a:almo-ls}. 
In the current implementation, a localization center is a set of all local Gaussian atomic orbitals of one molecule. 
However the approach can be easily generalized to other local and nonlocal basis sets~\cite{a:ls-galli-parrinello-1992, RZK:10.1016/j.jcp.2011.11.032}. 
The key feature of ALMO DFT is that its one-electron wavefunctions are constructed in a two-step self-consistent-field (SCF) procedure~\cite{a:almo-ls} to circumvent the problem of the sluggish variational optimization emphasized above. 
In the first step, ALMOs are constrained to their localization centers~\cite{a:khal} whereas, in the second step, ALMOs are relaxed to allow delocalization onto the neighbor molecules within their localization radius $R_{c}$. 
To achieve a robust optimization in the problematic second step, it is important to keep the delocalization component of the trial wavefunction orthogonal to the fixed orbitals obtained in the first step. 
For mathematical details, see ALMO SCF method in Ref.~\citenum{a:almo-ls}.

ALMO constraints imposed by $R_c$ prohibit electron density transfer between distant molecules but retain all other types of interaction such as long-range electrostatic, exchange, polarization, and, if the exchange-correlation (XC) functional includes them, dispersion interactions~\cite{a:theeda}. 
Since the importance of electron transfer decays exponentially with distance, the \mbox{ALMO} approximation is expected to provide a natural and accurate representation of the electronic structure of molecular systems. %with just a few local variables. 
Because of the greatly reduced number of electronic descriptors and the robust optimization, the computational complexity of ALMO DFT grows linearly with the number of molecules while its computational overhead remains very low. These features make ALMO DFT a promising method for accurate AIMD simulations of large molecular systems.

%To decrease the cost even further, the present paper builds on the ALMO SCF method as well as other recent work involving Brownian dynamics to compensate errors in the forces~\cite{a:ls-parinello,a:2ndcpmd,a:langevin-why}. 
%We will show that our approach lowers the computation cost pre-factor for the ALMO SCF method, while maintaining LS and accuracy for calculation of dynamical properties. 
%This is done by balancing a new computationally economical but systemically inaccurate force calculation method with an optimized version of the Langevin equation. 
%We also introduce an easy to follow heuristic approach to optimize a system for generating correct dynamical behaviour.

The challenge of adopting ALMO DFT for dynamical simulations arises from the slightly nonvariational character of the localized orbitals. First, while ALMOs are variationally optimized in both SCF steps, the occupied subspace defined in the first step must remain fixed during the second step to ensure convergence. Second, neglected electron transfer effects can suddenly become active in the course of a dynamical simulation when a neighboring molecule passes the localization threshold $R_{c}$. In addition to these issues characteristic to ALMOs, the variational optimization in any AIMD method is never truly complete and interrupted once the maximum norm of the gradient of the energy with respect to the electronic descriptors drops below small but nevertheless finite convergence threshold $\epsilon_{\text{SCF}}$. While these nonvariational errors do not affect the accuracy of static ALMO DFT calculations, geometry optimization, and Monte-Carlo simulations, they accumulate in molecular dynamics trajectories leading to non-physical sampling and eventual failure. 
Traditional strategies to cope with these problems are computationally expensive and include computing the nonvariational contribution to the forces via a variational coupled-perturbed procedure, increasing $R_c$, and decreasing $\epsilon_{\text{SCF}}$. 
%This however would dramatically increase the computational cost of the ALMO AIMD. %as longer-distance but physically unimportant interactions must be calculated with an additional iterative coupled perturbed solver.

In this work, we propose another approach that obviates the need in a coupled-perturbed solver, relaxes tight constraints on $R_{c}$ and $\epsilon_{\text{SCF}}$, and thus enables us to maintain stable dynamics and to keep the complexity and cost of simulations low. 
%
In our approach, the forces on atoms are calculated \emph{approximately} after the two-step ALMO SCF using a straightforward procedure that computes only the Hellmann-Feynman and Pulay components and neglects the computationally intense nonvariational component of the forces. 
The difference between these approximate ALMO forces and the \emph{reference} forces that could be obtained from perfectly converged fully-delocalized KS orbitals is $\delta f_{i\alpha}(t)$:
%
\begin{align}
\label{eq:deltaf}
f^{\text{KS}}_{i\alpha}(t) = f^{\text{ALMO}}_{i\alpha}(t) + \delta f_{i\alpha} (t),
\end{align}
%
where $\alpha$ is a Cartesian component of the force acting on atom $i$ at time $t$. $\delta f_{i\alpha} (t)$ comprises all neglected terms that originate from a finite localization radius $R_c$ and incomplete SCF optimization. 
$\delta f_{i\alpha} (t)$ can be reduced to zero \emph{systematically} by increasing $R_c$ and decreasing $\epsilon_{\text{SCF}}$.

Our approach to compensate for the missing $\delta f_{i\alpha}(t)$ term follows the methodology that have been introduced into AIMD by Krajewski \emph{et al.}~\cite{RZK:PRB-73-041105R}, formalized by K\"uhne \emph{et al.}~\cite{a:2ndcpmd} and rationalized by Dai \emph{et al.}~\cite{a:langevin-why} before becoming informally known as the second generation Car-Parrinello molecular dynamics~\cite{RZK:10.1002/wcms.1176}. 
Inspired by this method, ALMO AIMD is chosen to be governed by the Langevin equation of motion that is first written in terms of the unknown reference forces:
%
\begin{align}
\label{eq:langevin}
m_i \ddot{r}_{i\alpha} = f^{\text{KS}}_{i\alpha}(t) - \gamma m_i \dot{r}_{i\alpha} + R^{\gamma}_{i\alpha} (t),
\end{align}
%
where $m_i$ is the mass of atom $i$, $r_{i\alpha}$ is its position along dimension $\alpha$, $\gamma$ is the Langevin scaling factor, and $R^{\gamma}_{i\alpha} (t)$ is the stochastic force represented by a zero-mean white Gaussian noise: %with the zero mean and the strength related to the damping term through $\gamma$:
%
\begin{align}
\label{eq:stochastic}
\langle R^{\gamma}_{i\alpha} (t) \rangle &= 0, \\
\langle R^{\gamma}_{i\alpha} (t)  R^{\gamma}_{j\beta} (t') \rangle &= 2 k_B T \gamma m_i \delta_{ij} \delta_{\alpha\beta} \delta(t-t').
\end{align}
% 
The last relation means that, for any value of $\gamma$, the damping and stochastic terms are in perfect balance and trajectories generated with Eq.~(\ref{eq:langevin}) will sample the canonical ensemble at specified temperature $T$~\cite{a:Kubo-1986}. 
%will generate the correct Maxwell-Boltzmann distribution of velocities for a desired temperature $T$~\cite{a:Kubo-1986}. 
Larger $\gamma$ lead to faster equilibration but more distorted results for dynamical properties. %In the limit $\gamma \rightarrow 0$, the Newton equation is recovered and the microcanonical ensemble is sampled. 

%It has previously been shown that Langevin dynamics can be utilized to correct inaccurate force calculations to maintain correct dynamical properties.~\cite{a:langevin-why,a:2ndcpmd,b:tuckerman-stat,a:ceriotti} 

%By utilizing Eq.\ (\ref{eq:langevin}) in conjunction with the ALMO SCF method of force calculation, we will show that discontinuity in the PES can be ignored for sufficiently large $\gamma$. 
% Perhaps this statement is not correct: Note that increasing $\gamma$ increases the sample size required to generate accurate dynamical properties, as more random Gaussian noise is introduced.

%The concept of balancing errors in force calculation with the Langevin equation can be taken even further, thereby reducing computational overhead even more. 
%%During the second step of the ALMO SCF method described above, a self-consistent variational approach is taken to converge the non-orthogonal MOs. 
%Generally, this step utilizes a iterative search function in order to reduce the absolute norm of the energy gradient to some target value $\epsilon_{\text{SCF}}$. 
%Previously, $\epsilon_{\text{SCF}}$ had to be set very small to ensure sufficient convergence of the electron structure calculations. 
%By increasing the allowable $\epsilon_{\text{SCF}}$, a great reduction in computational cost can be achieved. 
%Obviously, this introduces a significant error into the calculation of forces during each time step. 

The main assumption of ALMO AIMD is that the error in the ALMO forces is well approximated by Gaussian noise $R^{\Delta}_{i\alpha} (t)$:
%
\begin{align}
\label{eq:assumption}
\delta f_{i\alpha}(t) = R^{\Delta}_{i\alpha} (t)
\end{align}
%
that obeys
%
\begin{align}
\label{eq:stochastic2}
\langle R^{\Delta}_{i\alpha} (t) \rangle &= 0, \\
\label{eq:stochastic3}
\langle R^{\Delta}_{i\alpha} (t)  R^{\Delta}_{j\beta} (t') \rangle &= 2 k_B T \Delta m_i \delta_{ij} \delta_{\alpha\beta} \delta(t-t')
\end{align}
%
This assumption, shown to be well justified, allows us to rewrite the Langevin equation using the ALMO forces:
%
\begin{align}
\label{eq:langevin2}
m_i \ddot{r}_{i\alpha} = f^{\text{ALMO}}_{i\alpha}(t) - \gamma m_i \dot{r}_{i\alpha} + R^{\gamma + \Delta}_{i\alpha} (t)
\end{align}
%
where the two stochastic terms are combined into one $R^{\gamma + \Delta}_{i\alpha} = R^{\gamma}_{i\alpha} + R^{\Delta}_{i\alpha}$. 
The only missing piece in the modified Langevin equation is the value of $\Delta$, which describes the strength of the newly introduced stochastic term. 
This term compensates for imperfections in ALMO forces and must be adjusted to re-balance the damping and stochastic components in ALMO AIMD. %and generate the correct Maxwell-Boltzmann distribution in ALMO AIMD. 

%%Note that $\Delta$ can be either positive or negative depending on the system of interest. 
%%$\Delta$ was found to be positive for all simulations considered here. %, increasing the amplitude of the effective random force on the system.

%\section{Optimizing $\Delta$}

%RZK: There is a problem with the integral equation below. The r.h.s. depends on $i$ but in the l.h.s. does not. If I remember correctly we evaluate the integral for molecules, not atoms. In liquid water all our molecules are the same and we do not have to deal with the issue of different Delta for different molecules. Eliminating the problem
In principle, $\Delta$ can be calculated using the integral of Eq.~(\ref{eq:stochastic3}) weighed over all types of atoms with different $m_i$
%
\begin{align}
\label{eq:delta}
\Delta &= (6 k_B T m_i )^{-1} \int_{-\infty}^{\infty} \langle \delta \vec{f}_i (0) \cdot \delta\vec{f}_i(\tau) \rangle d\tau
\end{align}
%
if one can afford computing the reference forces $f^{\text{KS}}_{i\alpha}(t)$ (i.e. $R_c \rightarrow \infty$ and $\epsilon_{\text{SCF}} \rightarrow 0$) for a short representative AIMD trajectory. 
In practice, we found (see results below) that this approach is not particularly accurate due to the noisy autocovariance functions (ACF) from short trajectories and perhaps because the $\delta_{ij}\delta_{\alpha\beta}$ assumption in Eq.~(\ref{eq:stochastic3}) does not strictly hold. 
Nevertheless, the ACF integral can provide a reasonable starting value of $\Delta$. This value can be further fine-tuned in a series of short trial-and-error ALMO AIMD runs until the average kinetic energy corresponds to the requested temperature $\langle \frac{1}{2} m_i \dot{\bm{r}}^{2}_{i} \rangle = \frac{3}{2} k_{B} T$ .
%%
%\begin{align}
%\label{eq:eqipartition}
%\langle \dfrac{1}{2} m_i \dot{\bm{r}}^{2}_{i} \rangle &= \dfrac{3}{2} k_{B} T
%\end{align}


%\section{Implementation}

\begin{figure}
\includegraphics[trim={1.3cm 0.1cm 3.3cm 1.3cm},clip,width=8.6cm]{Dynamical_Data_Tiled.eps}
\caption{\label{fig:dynproperties} 
Calculated properties of water using ALMO AIMD with $\epsilon_{\text{SCF}} = 10^{-2}$~a.u. and $R_{c} = 1.6$ vdWR (red line) and fully converged OT reference (black line).
(a) RDF, 
(b) kinetic energy distribution (the black curve shows the theoretical Maxwell-Boltzmann distribution), 
(c) IR spectrum.
%Calculations were performed with the PBE $\mathrm{E_{XC}}$ functional and TZV2P basis set, using 125 water molecules for 10 ps.
}
\end{figure}

ALMO AIMD presented here was implemented in CP2K, an open source materials modeling package~\cite{www:cp2k}. 
Accuracy and efficiency of ALMO AIMD was tested using liquid water as an example. 
This system is challenging because intermolecular electron delocalization is a critical component of hydrogen bonding and must be described correctly to reproduce static and dynamical properties of liquid water. 
%To calculate properties of water at ambient conditions, 
A periodic cell containing 125 molecules was simulated for $\SI{10}{\ps}$ at $T=\SI{298}{\K}$ and a constant density of $\SI{1.01}{\g\cdot\cm^{-3}}$. 
Ricci-Ciccotti algorithm~\cite{RZK:10.1080/0026897031000108113} was used to integrate the Langevin equation. We found that $\gamma = \SI{e-3}{\per\fs}$ is large enough to thermostat the system efficiently and small enough not to significantly affect dynamical properties of liquid water.
%
In the dual Gaussian and plane-wave scheme implemented in CP2K~\cite{a:quickstep}, the TZV2P basis set was used to represent molecular orbitals, and a plane-wave cutoff of $\SI{320}{Ry}$ used to represent electron density. 
The XC energy was approximated using the PBE functional~\cite{a:PBEfunctional}. 
Separable norm-conserving pseudopotentials were used~\cite{a:hgh} and the Brillouin zone was sampled at the $\Gamma$-point. 
%to describe the interactions between the valence electrons and the ionic cores. 

The \emph{reference} forces were calculated with fully delocalized electrons using tightly converged, $\epsilon_{\text{SCF}}=10^{-6}$~a.u., orbital transformation (OT) method~\cite{a:ot}. 
In ALMO AIMD, element-specific cutoff radius for electron delocalization $R_c$ was set to 1.6 in units of the elements' van der Waals radii (vdWR). This localization radius includes approximately two coordination shells of an average water molecule and was shown to reproduce the reference radial distribution function (RDF) perfectly in Monte-Carlo simulations~\cite{a:almo-ls}. 
%
To measure the ability of the $R^{\Delta}$ term to compensate for imperfections in ALMO forces we varied $\epsilon_{\text{SCF}}$ between tight $10^{-6}$~a.u. and loose $10^{-2}$~a.u. 

\begin{figure}
\includegraphics[trim={0.5cm 0cm 0.7cm 0.1cm},clip,width=8.6cm]{DeltaForceComparison_with_ACF.eps}
\caption{\label{fig:randomforce} 
%RZK: label of the third panel: "d" -> "c" 
The red line is the Euclidean norm of the instantaneous error $\langle \| \delta \vec{f_{i}}(t) \| \rangle_{i}$, the black line is the magnitude of the time average of the instantaneous error vector, and the green line is the time average of the red line. 
%(a) $R_{c} = 1.6$ vdWR and $\epsilon_{\text{SCF}} = 10^{-2}$~a.u. relative to the fully converged ALMO reference, 
(a) $R_{c} = 1.6$ vdWR and $\epsilon_{\text{SCF}} = 10^{-2}$~a.u., 
(b) $R_{c} = 1.6$ vdWR and fully converged ALMO SCF, 
(c) Normalized ACF $\frac{1}{3}\langle \delta \vec{f}_i (t) \cdot \delta\vec{f}_i(t+\tau) \rangle_{it}$ of the instantaneous error in panel (a).
%Forces are computed with the PBE XC functional and TZV2P basis set for the configurations from a 10-ps trajectory generated with KS-based AIMD at T=298~K. 
}
\end{figure}

Even with $\epsilon_{\text{SCF}} = 10^{-2}$, we stabilized the simulation at the correct average temperature and perfect Maxwell-Boltzmann distribution (Figure~\ref{fig:dynproperties}b). $\Delta$ was initially estimated at $\SI{2e-5}{\per\fs}$ using Eq.~(\ref{eq:delta}) and then refined heuristically to $\SI{6e-5}{\per\fs}$. 
%RZK: factor of 3 bothers me. We need to check that this is not because we sum over 3 atoms in a molecule. See previous comments on the ACF integral.
We found that it is easier to optimize $\Delta$ when $\gamma$ is set to zero because of reduced noise in the trial runs. 
%In theory, $\Delta$ should be independent on system size. However, we found that $\Delta$ dependents on system size due to finite size effects, which decay for increasing system size.
%
Analysis of $\delta \vec{f_{i}}(t)$ shows that the error indeed resembles Gaussian white noise. The mean of the error is zero (black line in Figure~\ref{fig:randomforce}a). Its ACF decays rapidly (Figure~\ref{fig:randomforce}c) so that the errors can be considered uncorrelated on time scale of $\SI{50}{\fs}$. Thus the main assumption behind our approach to ALMO AIMD is justified for liquid water. The main source of error in forces for this system is the loose convergence criterion and not the finite $R_c$: fully converged ALMO SCF calculations remove the rapidly oscillating component of the error (Figure~\ref{fig:randomforce}b). We also verified that the ALMO forces converge to the reference forces in the limit $R_{c} \rightarrow \infty$ 
%(Figure~\ref{fig:forcecomp} in the Supplemental Material).
(Figure~S1 in the Supplemental Material).

%we computed the average difference in force between fully converged Born-Oppenheimer forces and forces calculated from ALMO DFT with varying $R_{c}$. Figure \ref{fig:forcecomp} in the Supplemental Material shows that as $R_{c}$ is increased to infinity, forces converge toward the Born-Oppenheimer limit.

%\section{Accuracy}

To test the accuracy of ALMO AIMD we used trajectory analyzer TRAVIS~\cite{a:travis-main} to compute the infrared (IR) spectrum, RDF, and diffusion coefficient of liquid water from both the ALMO trajectory ($\epsilon_{\text{SCF}} = 10^{-2}$~a.u. and $R_{c} = 1.6$ vdWR) and from the reference trajectory.  
The diffusion coefficients $D_{\text{OT}}=\SI{5.47e-9}{\m^{2}\per\s}$ and $D_{\text{ALMO}}=\SI{5.55E-09}{\m^{2}\per\s}$ and RDFs (Figure~\ref{fig:dynproperties}a) are in perfect agreement. The quality of the ALMO IR spectrum (Figure~\ref{fig:dynproperties}c) is good despite minor errors in the intensity of the OH stretching mode, which is sensitive to the precise positions of the centers of localized orbitals. These stringent tests show that despite noticeable errors in the ALMO forces (Figure \ref{fig:randomforce}a) the compensating $R^{\Delta}$ term in the modified Langevin equation makes it possible to recover atomic dynamics properly. We would like to note that ALMO AIMD could not be stabilized with $\Delta=0$. Neither we were able to find any values of $\Delta$ that stabilize trajectories generated using perturbative versions of ALMO DFT~\cite{a:almo-ls}.

%\section{Speed}

%RZK addition for a longer article: extrapolation of WFs on both SCF steps is a crucial component of our fast algorithm.

To demonstrate the computational advantage of ALMO AIMD, we compared the average wall-time per MD step over 10 time steps for a variety of methods in Figure \ref{fig:strongscaling_log}.
In addition to the fully converged OT reference, we included timing for the second generation Car-Parrinello method designed to decrease the computational prefactor of the cubically scaling OT method~\cite{a:2ndcpmd}.
As expected ALMO methods show clear LS behavior for all values of $\epsilon_{\text{SCF}}$ even for medium-size systems. 
%OT SCF scales approximately cubically, as expected.
For liquid water, strict localization of ALMOs lowers the crossover point between ALMO AIMD and cubically scaling methods to 256 molecules -- length scales routinely accessible with AIMD today. It is important to emphasize that the comparison is performed for a three-dimensional condensed phase system described with a large diffuse basis set -- a particularly challenging case for LS methods.

\begin{figure}
\includegraphics[trim={2.5cm 0.5cm 3.4cm 0.9cm},clip,width=8.6cm]{strongscaling_log.eps}
\caption{\label{fig:strongscaling_log} Timing benchmarks for PBE/TZV2P simulations of liquid water on 256 compute cores. 
%Logscale plots which show the asymptotic LS behaviour of ALMO methods for liquid water at 298 K.
%Compared with the orbital transformation using fully converged SCF and second generation Car-Parinello force calculation methods.~\cite{a:ot,a:ot2,a:2ndcpmd}
For ALMO methods, $R_{c} = 1.6$ vdWR. 
Cyan lines represent perfect cubic scaling, whereas gray lines represent perfect linear scaling. 
}
\end{figure}

% RZK addition for a longer article: parallel performance of the algorithm. Vertical line at drawn at 8k molecules shows peculiar behavior of the code. preferred Ncores = integer^2 ?

Weak scaling benchmarks for very large systems show (Figure~\ref{fig:weakscaling}) that localized orbitals are naturally suited for parallel execution and that the computational cost of our implementation grows linearly for a wide range of compute cores. 
In fact, we were able to successfully simulate systems as large as 32768 water molecules within reasonable wall-clock time using moderate number of compute cores -- unprecedented feat for AIMD considering that accurate molecular orbitals and the idempotent DM are computed on each step.
The horizontal line in Figure~\ref{fig:weakscaling} is shown as a rough guide to time and length scales accessible in a fixed wall-clock time given various computational resources. It indicates that ALMO AIMD can extend the range of routine simulations to $\sim10^4$ atoms on modern HPC platforms. 

%We also show that systems as large as 8192 molecules can be simulated for 10,000 MD steps in under a month using this method.

\begin{figure}
\includegraphics[trim={1.6cm 0.8cm 4.7cm 0cm},clip,width=8.6cm]{weakscaling.eps}
\caption{\label{fig:weakscaling} Weak scalability benchmarks for PBE/TZV2P ALMO AIMD with  $R_{c} = 1.6$ vdWR and $\epsilon_{\text{SCF}} = 10^{-2}$~a.u. 
Dashed gray lines connect systems simulated on the same number of cores to confirm LS behavior. %over a range of configurations.
}
\end{figure}

%\section{Conclusions} 

% systematically improvable approximation to DFT-based AIMD.
To summarize, we demonstrated, for the first time, the utility of compact localized orbitals for low-cost linear-scaling AIMD for weakly-interacting systems. 
High efficiency is achieved without sacrificing accuracy with a combination of two techniques: (1) on-the-fly calculation of approximate forces without lengthy self-consistent optimization of localized orbitals and (2) integration of a modified Langevin equation of motion that is fine-tuned to retain stable and correct dynamics even with imperfect forces. 
A remarkable feature of the method is that it remains efficient for challenging condensed phase systems even with diffuse atom-centered basis sets. 
Using liquid water as an example, we showed that the new AIMD method enables simulations of molecular systems on previously inaccessible time and length scales. 
The developed methods will have a significant impact on modeling of complex molecular systems (e.g. interfaces, nuclei) making completely new phenomena accessible to AIMD. 
Generalization of the methodology to systems of strongly interacting atoms (e.g. covalent crystals) is underway.

\textbf{Acknowledgments.} The research was funded by the Natural Sciences and Engineering Research Council of Canada through the Discovery Grant. The authors are grateful to Compute Canada and McGill HPC Centre for computer time.

%RZK: incorrect journal abbreviation in a:almo-ls, formatting of all references must be checked

\bibliography{almo-langevin}

\else

\subsection{Analytical expression for $\Delta$}
%
%Another approach based on Eq. (\ref{eq:assumption}) can be used to find $\Delta$ within an order of magnitude if one can afford computing tightly converged SCF forces for a short MD trajectory. 
%First, run the simulation with $\Delta = 0$ and converged SCF forces. 
%Second, compute approximate forces for snapshots along the trajectory and calculate the random term $R^{\Delta}_{i\alpha} (t)$ using Eq.\ \ref{eq:assumption}. 
%Third, calculate the autocovariance function (ACF) of the noise $\text{ACF}(t) = \langle R^{\Delta}_{i\alpha} (0)  R^{\Delta}_{i\alpha} (t) \rangle$, which should be sharply peaked around zero lag time if our assumption is correct. 
%Finally, integrate Eq.(\ref{eq:stochastic3}) to obtain the following expression for $\Delta$.
%%
%\begin{align}
%\label{eq:delta}
%\Delta &= (2 k_B T m_i )^{-1} \int_{-\infty}^{\infty}\langle R^{\Delta}_{i\alpha} (0)  R^{\Delta}_{i\alpha} (t) \rangle dt
%\end{align}
%%
%In other words, we use the integral of the ACF to estimate the strength of the random force. 

Among several possible expression for $\Delta$ we consider the following two options.

\textbf{Option 1.} $\Delta$ is calculated as a weighted average of atom TYPES (e.g. oxygen and hydrogen). Subindex $\text{T}$ refers to atom type.

\textbf{\emph{Step 1.}} Compute the average ACF for each atom type. In this step averaging is done over all time origins $t$, over all atoms of THIS type $i$, and over all dimensions $\alpha$. The ACF includes the mass-dependent factor $(2 k_B T m_\text{T} )^{-1}$ where $T$ is the requested temperature.
%
\begin{align}
\label{eq:deltaS1}
\text{ACF}_{\text{T}}(\tau) = (2 k_B T m_\text{T} )^{-1} \, \langle \delta f_{i\alpha} (t) \, \delta f_{i\alpha}(t + \tau) \rangle_{t i\alpha}
\end{align}
%
\textbf{\emph{Step 2.}} Integrate the ACF for each atom type.
%
\begin{align}
\label{eq:deltaS2}
\Delta_{\text{T}} = \int_{-\infty}^{\infty} \text{ACF}_{T}(\tau) \, d\tau
\end{align}
%
\textbf{\emph{Step 3.}} Average all over all atom types.
%
\begin{align}
\label{eq:deltaS3}
\Delta = \frac{1}{N} \sum_{\text{T}} N_{\text{T}} \Delta_{\text{T}}
\end{align}
%
where $N$ is the number of atoms.

If all these step are combined the following expression for $\Delta$ is obtained:
%
\begin{align}
\label{eq:deltaTOT}
\Delta = \int \, d\tau \left[ \frac{1}{3N} \sum_{i=1}^{N} \sum_{\alpha=1}^{3} \frac{ \langle \delta f_{i\alpha} (t) \, \delta f_{i\alpha}(t + \tau) \rangle_{t} }{2 k_B T m_i} \right]
\end{align}
%
Thus the weight of each of the $3N$ degrees of freedom in this scheme is proportional to the inverse atomic mass.

\textbf{Option 2.} If the same averaging scheme is applied to MOLECULE types (not ATOM types) then the value of $\Delta$ is given by:
%
\begin{align}
\label{eq:O2deltaTOT}
\Delta = \int \, d\tau \left[ \frac{1}{3M} \sum_{p=1}^{M} \sum_{\alpha=1}^{3} \frac{ \sum_i^{N_p}\sum_j^{N_p} \langle \delta f_{i\alpha} (t) \, \delta f_{j\alpha}(t + \tau) \rangle_{t} }{2 k_B T \sum_k^{N_p}m_k} \right]
\end{align}
%
where $M$ is the number of molecules, $N_p$ is the number of atoms in molecule $p$. The value of this $\Delta$ might be different from Option 1 because (a) all correlations between two atoms inside one molecule are taken into account and (b) the weight of each degree of freedom is different. The difference between Option 1 and 2 can be clearly seen for a special case of identical molecules:
%
\begin{align}
\label{eq:O2deltaSPECIAL}
\Delta = \int \, d\tau \left[ \frac{1}{3M} \sum_{i=1}^{N} \sum_{\alpha=1}^{3} \frac{ \sum_j^{N_p} \langle \delta f_{i\alpha} (t) \, \delta f_{j\alpha}(t + \tau) \rangle_{t} }{2 k_B T \langle m \rangle } \right]
\end{align}
%
where $\langle m \rangle = (\sum_k^{N_p} m_k )/N_p$ is the average atom mass in a molecule.

\subsection{Dependence of the forces on the electron localization radius}

The ALMO forces converge to the reference forces as the electron localization radius increases (Figure~\ref{fig:forcecomp}).

\begin{figure}[h!]
\includegraphics[trim={0cm 0cm 0.1cm 0.1cm},clip,width=8.6cm]{DeltaForceComparison_ALMO_SCF.eps}
\caption{\label{fig:forcecomp} Dependence of the Euclidean norm of the instantaneous error $\langle \| \delta \vec{f_{i}}(t) \| \rangle_{i}$ (red line) on the ALMO localization radius $R_c$ expressed in units of atomic van der Waals radii. Black line is the magnitude of the time average of the instantaneous error vector. %calculated as the average difference between fully converged Born-Oppenheimer forces and fully converged ALMO DFT forces, averaged over all dimensions and all molecules for each time step. 
Forces are computed with the PBE XC functional, TZV2P basis set, and $\epsilon_{\text{SCF}} = 10^{-7}$~a.u. for the configurations from a 10-ps trajectory generated with KS-based AIMD at T=298~K.}
\end{figure}

%\begin{figure}[!htb]
%\includegraphics[trim={1.7cm 0.5cm 3.3cm 0.1cm},clip,width=\textwidth]{strongscaling_linear.eps}
%\caption{\label{fig:strongscaling_linear} Linear plots showing LS behaviour of all ALMO methods for liquid water at 298 K. 
%Calculations were performed with the PBE $\mathrm{E_{XC}}$ functional and TZV2P basis set, averaged over 10 MD steps. 
%The localization radius was set to $R_{c} = 1.6$ vdWR and $\epsilon_{\text{SCF}} = 10^{-2}$~a.u.}
%\end{figure}

%\begin{figure}[!htb]
%\includegraphics[trim={2.5cm 0.2cm 4.5cm 1.2cm},clip,width=\textwidth]{Diffusion_Comparison.eps}
%\caption{\label{fig:diffusion} Calculated mean-squared displacement function of water using ALMO DFT with $\epsilon_{\text{SCF}} = 10^{-2}$~a.u. and $R_{c} = 1.6$ vdWR.
%Compared with equivalent MD run using OT DFT as a reference.
%Calculations were performed at 298 K with the PBE $\mathrm{E_{XC}}$ functional and TZV2P basis set, using 125 water molecules for 10 ps.}
%\end{figure}

\fi % SI - main text switch

\end{document}
